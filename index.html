<!DOCTYPE html>
<html>
<body>

// include the Dynamic Content Extensions SDK

<script src="https://unpkg.com/dc-extensions-sdk/dist/dc-extensions-sdk.umd.js"></script>

<div>HTML Static Landing page UI Extension</div>
<div>
  <p class="areWeInSync">HTML generated: <span class="yesOrNo"></span></p>
</div>

<script>

    class Extension {
      constructor(sdk) {

        this.sdk = sdk;

        //Debugging to check paramaters
        console.log("params", this.sdk.params);
        const locales = this.sdk.locales;
        console.log("locales", locales);

        this.currentValue = "";
        this.syncVisual = document.querySelector(".areWeInSync .yesOrNo");

        this.setCurrentValue()
        .then(() => { 
          //Get the deliveryId of teh current page contentType
          this.assignCurrentDeliveryId()
          .then(deliveryId => {
            //Call teh Delivery API to get the rendered HTML content
            this.getRawHtmlFromDeliveryAPI(deliveryId)
            .then(data => {
              console.log("currentValue", this.currentValue);
              console.log("newValue", data);
              console.log("isEqual", this.currentValue == data);
              if (this.currentValue === data){
                this.syncVisual.innerHTML = "Yep!";
              } else {
                this.syncVisual.innerHTML = "Nope!";
              }
              //Assign HTML generated value
              this.updateFieldValue(data);
            });
          })
        })
        .finally(() => {
          //force the height of the UI extemsion to be 0 (hidden)
          this.sdk.frame.stopAutoResizer();
          this.sdk.frame.setHeight(0)
        })
      }

      async updateFieldValue(value) {
        try {
          await this.sdk.field.setValue(value);
        } catch (err) {
          // the field value is not set to the new value, write a warning on the console
          console.log(err.message);
        }
      }

      async setCurrentValue() {
        try {
          const savedValue = await this.sdk.field.getValue();
          if (typeof savedValue !== "undefined") {
            //do nothing but keep track of current value
            this.currentValue = savedValue;
          }
        } catch (err) {
          console.log(err);
        }
      }

      async assignCurrentDeliveryId(){
        try {
          let contentItem = await this.sdk.contentItem.getCurrent();
          if (typeof contentItem !== "undefined") {
            return contentItem.deliveryId;
          }
        } catch (err) {
          console.log(err)
        }
      }

      async getRawHtmlFromDeliveryAPI(deliveryId) 
      {
        let response = await fetch(`https://c1.adis.ws/v1/content/gaptest/content-item/${deliveryId}?template=acc-template-static-landing-page&locale=,en-*,*`);
        let data = await response.text();
        return data;
      }
    }


(async function  () {
    try {
      new Extension(await dcExtensionsSdk.init())
    } catch (e) {
      document.body.innerHTML = 'Failed to initialize the Extension'
    }
})()


  </script>

  </body>

</html>