<!DOCTYPE html>
<html>
<body>

// include the Dynamic Content Extensions SDK

<script src="https://unpkg.com/dc-extensions-sdk/dist/dc-extensions-sdk.umd.js"></script>

<div>HTML Static Landing page UI Extension</div>
<div>
  <textarea class="rawHtml" name="rawHtml"></textarea>
</div>

<script>

    class Extension {
      constructor(sdk) {
        this.rawHtmlInput = document.querySelector(".rawHtml");

        this.sdk = sdk;
        console.log("params", this.sdk.params);
        const locales = this.sdk.locales;
        console.log("locales", locales);

        this.currentValue = "";
        this.currentDeliveryId = "";
        //Get Content Item

        // this.assignCurrentDeliveryId()
        //     .then(() => {
        //       this.getRawHtmlFromDeliveryAPI(this.currentDeliveryId)
        //         .then(data => console.log("data", data));
        //     })
        //     .finally(() => {
        //       console.log("deliveryId", this.currentDeliveryId);
        //     })

        const fieldValue = await this.sdk.field.getValue();
        console.log("fieldValue", fieldValue);
        const fieldValue2 = await this.sdk.component.getValue();
        console.log("fieldValue2", fieldValue2);

        this.setCurrentValue()
        .then(() => { 
          //Get the deliveryId of teh current page contentType
          this.assignCurrentDeliveryId()
          .then(deliveryId => {
            //Call teh Delivery API to get the rendered HTML content
            this.getRawHtmlFromDeliveryAPI(deliveryId)
            .then(data => {
              //Assign HTML generated value
              this.rawHtmlInput.value = data;
            });
          })
        })
        .finally(() => {
          //this.initializeInput();
          this.sdk.frame.startAutoResizer();
        })
      }

      async updateFieldValue(value) {
        try {
          await this.sdk.field.setValue(data);
        } catch (err) {
          // the field value is not set to the new value, write a warning on the console
          console.log(err.message);
        }
      }

      async setCurrentValue() {
        try {
          const savedValue = await this.sdk.form.getValue();
          console.log("savedValue", savedValue);
          if (typeof savedValue !== "undefined") {
            this.currentValue = savedValue;
            this.rawHtmlInput.value = savedValue;
          }
        } catch (err) {
          console.log(err);
        }
      }

      async assignCurrentDeliveryId(){
        try {
          let contentItem = await this.sdk.contentItem.getCurrent();
          if (typeof contentItem !== "undefined") {
            return contentItem.deliveryId;
          }
        } catch (err) {
          console.log(err)
        }
      }

      async getRawHtmlFromDeliveryAPI(deliveryId) 
      {
        let response = await fetch(`https://c1.adis.ws/v1/content/gaptest/content-item/${deliveryId}?template=acc-template-static-landing-page&locale=,en-*,*`);
        let data = await response.text();
        return data;
      }
   
      // initializeInput() {
      //   const { min = 0, max = 10, value = 0 } = this.sdk.params.instance;

      //   Object.assign(this.slider, {
      //     min,
      //     max,
      //     value
      //   });

      //  // set the slider value to the saved value if the content item has been previously saved 
      //  if (this.currentValue != 0) 
      //      this.slider.value = this.currentValue;

      //   // get the label to show the current slider value
      //   this.inputValue.innerHTML = this.slider.value;
      //   this.slider.onchange = event => this.onInputChange(event);

      //  }


      // onInputChange({ target: { value } }) {
      //   this.inputValue.innerHTML = value;
      //   this.updateFieldValue(value);
      // }

    }


(async function  () {
    try {
      new Extension(await dcExtensionsSdk.init())
    } catch (e) {
      document.body.innerHTML = 'Failed to connect'
    }
})()


  </script>

  </body>

</html>